<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sample Organizer - Phase 2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #2d3748; }
        .dark ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #64748b; }
        ::-webkit-scrollbar-thumb:hover { background: #718096; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); display: flex;
            justify-content: center; align-items: center; z-index: 50;
            opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-backdrop.active { opacity: 1; visibility: visible; }
        .modal-content { transform: scale(0.9); transition: transform 0.3s ease; }
        .modal-backdrop.active .modal-content { transform: scale(1); }

        /* Gradient text */
        .gemini-gradient-text {
            background-image: linear-gradient(to right, #4285F4, #9B59B6, #E94298);
            -webkit-background-clip: text; background-clip: text; color: transparent;
        }
        .dark .gemini-gradient-text-dark {
             background-image: linear-gradient(to right, #699CFF, #B87FE0, #F06EAD);
            -webkit-background-clip: text; background-clip: text; color: transparent;
        }
        textarea {
            min-height: 80px; /* Initial height */
            overflow-y: hidden; /* Hide scrollbar, rely on auto-resize */
            resize: none; /* Disable manual resize if auto-resize is good */
        }
        /* Styles for the 9x9 storage box table */
        .storage-box-table {
            border-collapse: collapse;
            margin: 20px auto;
            table-layout: fixed;
        }
        .storage-box-table th, .storage-box-table td {
            border: 1px solid #cbd5e1; /* slate-300 */
            width: 3rem; 
            height: 3.25rem; 
            text-align: center;
            vertical-align: middle;
            font-size: 0.75rem; 
            padding: 2px;
            overflow-wrap: break-word; 
            line-height: 1.2; 
        }
        .dark .storage-box-table th, .dark .storage-box-table td {
            border-color: #475569; /* slate-600 */
        }
        .storage-box-table th.row-header {
            background-color: #f1f5f9; /* slate-100 */
            font-weight: bold;
        }
        .dark .storage-box-table th.row-header {
            background-color: #334155; /* slate-700 */
        }
        .storage-box-table td.empty-slot {
            background-color: #f8fafc; /* slate-50 */
        }
        .dark .storage-box-table td.empty-slot {
            background-color: #1e293b; /* slate-800 or 900 */
            color: #64748b; /* slate-500 for placeholder text */
        }
        /* Styles for sorted list table */
        .sorted-list-table td, .sorted-list-table th {
            padding: 0.5rem 0.75rem;
            vertical-align: top;
        }
        .sorted-list-table ul {
            list-style-type: none;
            padding-left: 0;
            margin:0;
        }
        .sorted-list-table li {
            padding: 2px 0;
        }
        /* Styles for duplicate input highlight */
        .duplicate-highlight-input {
            border-width: 2px !important; /* Ensure it overrides other border styles */
            border-color: #ef4444 !important; /* Tailwind red-500 */
            box-shadow: 0 0 0 2px #ef4444 !important; /* Ring effect */
        }
        .dark .duplicate-highlight-input {
            border-color: #f87171 !important; /* Tailwind red-400 for dark mode */
            box-shadow: 0 0 0 2px #f87171 !important;
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { fontFamily: { sans: ['Inter', 'sans-serif'] } } }
        }
    </script>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200 min-h-screen flex flex-col items-center pt-6 sm:pt-10 pb-10 transition-colors duration-300">

    <div class="fixed top-4 right-4 z-20 flex items-center space-x-2 bg-white dark:bg-slate-800 p-2 rounded-lg shadow-md">
        <i class="fas fa-sun text-yellow-500"></i>
        <label for="darkModeToggle" class="relative inline-flex items-center cursor-pointer">
            <input type="checkbox" id="darkModeToggle" class="sr-only peer">
            <div class="w-11 h-6 bg-slate-300 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-sky-500 dark:peer-focus:ring-sky-600 rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-slate-600 peer-checked:bg-sky-600"></div>
        </label>
        <i class="fas fa-moon text-sky-500"></i>
    </div>

    <div class="container mx-auto px-4 w-full max-w-4xl">
        <header class="text-center mb-8 sm:mb-12">
            <h1 id="mainHeader" class="text-4xl sm:text-5xl font-bold pb-2">Sample Organizer</h1>
        </header>

        <div id="messageArea" class="mb-6 text-center text-sm"></div>

        <div class="bg-white dark:bg-slate-800 shadow-xl rounded-xl p-6 sm:p-8 mb-8 transition-colors duration-300">
            <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-center text-sky-600 dark:text-sky-400">Sample Scan Input</h2>
            <div id="scanInputsContainer">
                <div class="flex flex-col sm:flex-row gap-4">
                    <div class="flex-1 min-w-0">
                        <label for="wholeBloodScans" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Whole Blood Samples</label>
                        <textarea id="wholeBloodScans" name="wholeBloodScans" rows="3" class="scan-input w-full px-3 py-2 text-sm border border-slate-300 dark:border-slate-600 rounded-md focus:ring-sky-500 focus:border-sky-500 dark:bg-slate-700 dark:text-slate-200" placeholder="Scan or type QR codes... e.g.,
TP25-B12 13
TP25-B12 24"></textarea>
                    </div>
                    <div class="flex-1 min-w-0">
                        <label for="serumScans" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Serum Samples</label>
                        <textarea id="serumScans" name="serumScans" rows="3" class="scan-input w-full px-3 py-2 text-sm border border-slate-300 dark:border-slate-600 rounded-md focus:ring-sky-500 focus:border-sky-500 dark:bg-slate-700 dark:text-slate-200" placeholder="Scan or type QR codes... e.g.,
TP25-B12 13
TP25-B12 24"></textarea>
                    </div>
                    <div class="flex-1 min-w-0">
                        <label for="plasmaScans" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Plasma Samples</label>
                        <textarea id="plasmaScans" name="plasmaScans" rows="3" class="scan-input w-full px-3 py-2 text-sm border border-slate-300 dark:border-slate-600 rounded-md focus:ring-sky-500 focus:border-sky-500 dark:bg-slate-700 dark:text-slate-200" placeholder="Scan or type QR codes... e.g.,
TP25-B12 13
TP25-B12 24"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex flex-col sm:flex-row gap-4 mb-8">
            <button id="sortSamplesBtn" class="flex-1 px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg shadow-lg transition-transform hover:scale-105 focus:ring-2 focus:ring-green-400 focus:outline-none text-base sm:text-lg">
                <i class="fas fa-sort-amount-down mr-2"></i>Sort Samples
            </button>
            <button id="resetAppBtn" class="flex-1 px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg shadow-lg transition-transform hover:scale-105 focus:ring-2 focus:ring-red-400 focus:outline-none text-base sm:text-lg">
                <i class="fas fa-trash-alt mr-2"></i>Start Over
            </button>
        </div>

        <div id="resultsCard" class="bg-white dark:bg-slate-800 shadow-xl rounded-xl p-6 sm:p-8 mb-8 transition-colors duration-300">
            <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-center text-sky-600 dark:text-sky-400">Sorted Sample Outputs</h2>
            <div id="noResultsMessage" class="text-center py-8 text-slate-500 dark:text-slate-400">
                <i class="fas fa-info-circle text-2xl mb-2"></i>
                <p>Enter scan data and click "Sort Samples" to see results here.</p>
            </div>
            <div id="outputsContainer" class="hidden space-y-8">
                <div>
                    <h3 class="text-lg font-semibold mb-3 text-indigo-600 dark:text-indigo-400">Storage Box Layout (9x9)</h3>
                    <div id="storageBoxContainer" class="overflow-x-auto"></div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-3 text-indigo-600 dark:text-indigo-400">Numerically Sorted Samples</h3>
                    <div id="sortedListContainer" class="overflow-x-auto"></div>
                </div>
            </div>
            <div id="exportButtonContainer" class="mt-6 hidden flex flex-col sm:flex-row sm:justify-center gap-4">
                <button id="exportCsvBtn" class="flex-1 sm:flex-none px-5 py-2.5 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow-md transition-colors focus:ring-2 focus:ring-blue-400 focus:outline-none">
                    <i class="fas fa-file-csv mr-2"></i>Export Sorted List to CSV
                </button>
                <button id="exportPdfBtn" class="flex-1 sm:flex-none px-5 py-2.5 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-lg shadow-md transition-colors focus:ring-2 focus:ring-purple-400 focus:outline-none">
                    <i class="fas fa-file-pdf mr-2"></i>Export Report to PDF
                </button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal-backdrop">
        <div class="modal-content bg-white dark:bg-slate-800 p-6 rounded-lg shadow-xl w-full max-w-sm mx-4">
            <h3 id="modalTitle" class="text-lg font-semibold mb-4 text-slate-700 dark:text-slate-200">Confirm Action</h3>
            <p id="modalMessage" class="text-sm text-slate-600 dark:text-slate-400 mb-6">Are you sure?</p>
            <div class="flex justify-end space-x-3">
                <button id="modalCancelBtn" class="px-4 py-2 text-sm font-medium text-slate-700 dark:text-slate-300 bg-slate-200 dark:bg-slate-600 hover:bg-slate-300 dark:hover:bg-slate-500 rounded-lg transition-colors">Cancel</button>
                <button id="modalConfirmBtn" class="px-4 py-2 text-sm font-medium text-white bg-sky-600 hover:bg-sky-700 rounded-lg transition-colors">Confirm</button>
            </div>
        </div>
    </div>

    <!-- PDF Naming Modal -->
    <div id="pdfNameModal" class="modal-backdrop">
        <div class="modal-content bg-white dark:bg-slate-800 p-6 rounded-lg shadow-xl w-full max-w-md mx-4">
            <h3 class="text-lg font-semibold mb-4 text-slate-700 dark:text-slate-200">Name PDF Report</h3>
            <div class="mb-4">
                <label for="pdfReportName" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Report Title:</label>
                <input type="text" id="pdfReportName" name="pdfReportName" class="w-full px-3 py-2 text-sm border border-slate-300 dark:border-slate-600 rounded-md focus:ring-sky-500 focus:border-sky-500 dark:bg-slate-700 dark:text-slate-200" placeholder="e.g., Weekly Sample Report">
            </div>
            <p id="pdfNameError" class="text-xs text-red-500 dark:text-red-400 mb-4 hidden"></p>
            <div class="flex justify-end space-x-3">
                <button id="pdfNameCancelBtn" class="px-4 py-2 text-sm font-medium text-slate-700 dark:text-slate-300 bg-slate-200 dark:bg-slate-600 hover:bg-slate-300 dark:hover:bg-slate-500 rounded-lg transition-colors">Cancel</button>
                <button id="pdfNameConfirmBtn" class="px-4 py-2 text-sm font-medium text-white bg-sky-600 hover:bg-sky-700 rounded-lg transition-colors">Generate PDF</button>
            </div>
        </div>
    </div>

    <!-- Duplicate Alert Modal -->
    <div id="duplicateAlertModal" class="modal-backdrop">
        <div class="modal-content bg-white dark:bg-slate-800 p-6 rounded-lg shadow-xl w-full max-w-md mx-4">
            <div class="flex items-center mb-4">
                <i class="fas fa-exclamation-triangle text-yellow-500 text-xl mr-3"></i>
                <h3 class="text-lg font-semibold text-slate-700 dark:text-slate-200">Duplicate Sample Alert</h3>
            </div>
            <p class="text-sm text-slate-600 dark:text-slate-400 mb-3">
                The following sample IDs have been entered multiple times. Please ensure each unique sample ID appears only once before sorting:
            </p>
            <ul id="duplicateList" class="list-disc list-inside text-sm text-red-600 dark:text-red-400 mb-6 max-h-48 overflow-y-auto bg-slate-100 dark:bg-slate-700 p-3 rounded-md">
                <!-- Duplicate items will be listed here -->
            </ul>
            <div class="flex justify-end">
                <button id="duplicateAlertCloseBtn" class="px-4 py-2 text-sm font-medium text-white bg-sky-600 hover:bg-sky-700 rounded-lg transition-colors">Acknowledge</button>
            </div>
        </div>
    </div>


    <script>
        // --- DOM Elements ---
        const darkModeToggle = document.getElementById('darkModeToggle');
        const mainHeader = document.getElementById('mainHeader');
        const messageArea = document.getElementById('messageArea');

        const wholeBloodScansTextarea = document.getElementById('wholeBloodScans');
        const serumScansTextarea = document.getElementById('serumScans');
        const plasmaScansTextarea = document.getElementById('plasmaScans');
        const scanTextareas = [wholeBloodScansTextarea, serumScansTextarea, plasmaScansTextarea];

        const sortSamplesBtn = document.getElementById('sortSamplesBtn');
        const resetAppBtn = document.getElementById('resetAppBtn');
        
        const resultsCard = document.getElementById('resultsCard');
        const noResultsMessage = document.getElementById('noResultsMessage');
        const outputsContainer = document.getElementById('outputsContainer');
        const storageBoxContainer = document.getElementById('storageBoxContainer');
        const sortedListContainer = document.getElementById('sortedListContainer');
        
        const exportButtonContainer = document.getElementById('exportButtonContainer');
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        const exportPdfBtn = document.getElementById('exportPdfBtn'); 

        const confirmationModal = document.getElementById('confirmationModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        const modalCancelBtn = document.getElementById('modalCancelBtn');
        let confirmCallback = null;

        const pdfNameModal = document.getElementById('pdfNameModal');
        const pdfReportNameInput = document.getElementById('pdfReportName');
        const pdfNameError = document.getElementById('pdfNameError');
        const pdfNameConfirmBtn = document.getElementById('pdfNameConfirmBtn');
        const pdfNameCancelBtn = document.getElementById('pdfNameCancelBtn');

        // Duplicate Alert Modal Elements
        const duplicateAlertModal = document.getElementById('duplicateAlertModal');
        const duplicateList = document.getElementById('duplicateList');
        const duplicateAlertCloseBtn = document.getElementById('duplicateAlertCloseBtn');
        let currentDuplicateIds = []; // Stores IDs for highlighting


        // --- App State & Config ---
        const CATEGORY_CONFIG = {
            "Whole Blood": { textarea: wholeBloodScansTextarea, rows: ['A', 'B', 'C'], color: 'bg-red-100 dark:bg-red-800', validRange: [1, 18] },
            "Serum":       { textarea: serumScansTextarea,    rows: ['D', 'E', 'F'], color: 'bg-yellow-100 dark:bg-yellow-800', validRange: [19, 34] },
            "Plasma":      { textarea: plasmaScansTextarea,   rows: ['G', 'H', 'I'], color: 'bg-blue-100 dark:bg-blue-800', validRange: [35, 74] }
        };
        const ALL_ROW_LABELS = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I'];
        let processedScans = {}; 
        let sortedScansByCategory = {}; 

        // --- Utility Functions ---
        function showMessage(message, type = 'info', duration = 3000) {
            messageArea.innerHTML = '';
            const messageDiv = document.createElement('div');
            let bgColor, textColor, iconClass;
            switch (type) {
                case 'success': bgColor = 'bg-green-100 dark:bg-green-900'; textColor = 'text-green-700 dark:text-green-300'; iconClass = 'fas fa-check-circle'; break;
                case 'error': bgColor = 'bg-red-100 dark:bg-red-900'; textColor = 'text-red-700 dark:text-red-300'; iconClass = 'fas fa-times-circle'; break;
                case 'warning': bgColor = 'bg-yellow-100 dark:bg-yellow-900'; textColor = 'text-yellow-700 dark:text-yellow-300'; iconClass = 'fas fa-exclamation-triangle'; break;
                default: bgColor = 'bg-sky-100 dark:bg-sky-900'; textColor = 'text-sky-700 dark:text-sky-300'; iconClass = 'fas fa-info-circle';
            }
            messageDiv.className = `p-3 rounded-md shadow ${bgColor} ${textColor} flex items-center space-x-2`;
            messageDiv.innerHTML = `<i class="${iconClass}"></i><span>${message}</span>`;
            messageArea.appendChild(messageDiv);
            setTimeout(() => {
                messageDiv.style.transition = 'opacity 0.5s ease';
                messageDiv.style.opacity = '0';
                setTimeout(() => {
                    if (messageDiv.parentNode === messageArea) {
                       messageArea.innerHTML = '';
                    }
                }, 500);
            }, duration);
        }
        function showConfirmation(title, message, onConfirm) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            confirmCallback = onConfirm;
            confirmationModal.classList.add('active');
        }
        function hideConfirmation() {
            confirmationModal.classList.remove('active');
            confirmCallback = null;
        }

        function showPdfNameModal() {
            const today = new Date().toISOString().slice(0,10);
            pdfReportNameInput.value = `Sample_Report_${today}`;
            pdfNameError.classList.add('hidden');
            pdfNameError.textContent = '';
            pdfNameModal.classList.add('active');
            pdfReportNameInput.focus();
            pdfReportNameInput.select();
        }
        function hidePdfNameModal() {
            pdfNameModal.classList.remove('active');
        }

        function showDuplicateAlertModal(duplicateInfo) { // duplicateInfo is { id: [categories] }
            duplicateList.innerHTML = ''; 
            currentDuplicateIds = Object.keys(duplicateInfo); // Store for highlighting

            currentDuplicateIds.forEach(id => {
                const li = document.createElement('li');
                const categoriesString = duplicateInfo[id].join(', ');
                li.textContent = `${id} (Found in: ${categoriesString})`;
                duplicateList.appendChild(li);
            });
            duplicateAlertModal.classList.add('active');
        }
        function hideDuplicateAlertModal() {
            duplicateAlertModal.classList.remove('active');
        }
        
        function highlightDuplicateTextareas(idsToHighlight) {
            let firstHighlightedTextarea = null;
            scanTextareas.forEach(textarea => {
                if (!textarea) return;
                const textareaValue = textarea.value;
                let containsDuplicate = false;
                for (const id of idsToHighlight) {
                    const lines = textareaValue.split('\n').map(line => line.trim());
                    if (lines.includes(id)) {
                        containsDuplicate = true;
                        break;
                    }
                }

                if (containsDuplicate) {
                    textarea.classList.add('duplicate-highlight-input');
                    if (!firstHighlightedTextarea) {
                        firstHighlightedTextarea = textarea;
                    }
                }
            });

            if (firstHighlightedTextarea) {
                firstHighlightedTextarea.focus();
                const inputSection = document.getElementById('scanInputsContainer');
                if (inputSection) {
                    inputSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }
        }

        function clearDuplicateHighlights() {
            scanTextareas.forEach(textarea => {
                if (textarea) textarea.classList.remove('duplicate-highlight-input');
            });
            currentDuplicateIds = [];
        }


        // --- Dark Mode & Header Styling ---
        function applyThemeAndHeaderStyle() {
            if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                if (darkModeToggle) darkModeToggle.checked = true;
                if (mainHeader) {
                    mainHeader.classList.add('gemini-gradient-text-dark');
                    mainHeader.classList.remove('gemini-gradient-text');
                }
            } else {
                document.documentElement.classList.remove('dark');
                if (darkModeToggle) darkModeToggle.checked = false;
                if (mainHeader) {
                    mainHeader.classList.add('gemini-gradient-text');
                    mainHeader.classList.remove('gemini-gradient-text-dark');
                }
            }
        }
        if (darkModeToggle) {
            darkModeToggle.addEventListener('change', () => {
                if (darkModeToggle.checked) {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                }
                applyThemeAndHeaderStyle();
            });
        }
        
        function autoResizeTextarea(eventOrTextarea) {
            const textarea = eventOrTextarea.target || eventOrTextarea;
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        function handleTextareaKeyDown(event) {
            const textarea = event.target;
            if (event.key === 'Enter') {
                event.preventDefault(); 
                const cursorPos = textarea.selectionStart;
                const textBefore = textarea.value.substring(0, cursorPos);
                const textAfter = textarea.value.substring(textarea.selectionEnd);
                textarea.value = textBefore + '\n' + textAfter;
                textarea.selectionStart = textarea.selectionEnd = cursorPos + 1;
                autoResizeTextarea(textarea); 
            }
        }

        function handleTextareaPaste(event) {
            event.preventDefault();
            const textarea = event.target;
            let pastedText = (event.clipboardData || window.clipboardData).getData('text');
            if (!pastedText) return;

            pastedText = pastedText.toUpperCase(); 

            const codes = pastedText.split(/[\n,]+/) 
                                    .map(code => code.trim())
                                    .filter(code => code.length > 0);
            
            let textToInsert = "";
            if (codes.length > 0) {
                textToInsert = codes.join('\n') + '\n'; 
            }

            const startPos = textarea.selectionStart;
            const endPos = textarea.selectionEnd;
            const currentVal = textarea.value;
            textarea.value = currentVal.substring(0, startPos) + textToInsert + currentVal.substring(endPos);
            
            const newCursorPos = startPos + textToInsert.length;
            textarea.selectionStart = textarea.selectionEnd = newCursorPos;
            autoResizeTextarea(textarea);
        }

        function handleTextareaInput(event) {
            const textarea = event.target;
            let value = textarea.value;
            let cursorPos = textarea.selectionStart;
            let modified = false;

            if (cursorPos > 0 && value.charAt(cursorPos - 1) === ',') {
                const textBeforeComma = value.substring(0, cursorPos - 1);
                const textAfterComma = value.substring(cursorPos);
                value = textBeforeComma + '\n' + textAfterComma;
                modified = true;
            }
            
            const upperValue = value.toUpperCase();
            if (value !== upperValue) {
                value = upperValue;
                modified = true;
            }

            if (modified) {
                textarea.value = value;
                textarea.selectionStart = textarea.selectionEnd = cursorPos;
            }
            
            autoResizeTextarea(textarea);
        }

        scanTextareas.forEach(textarea => {
            if (textarea) {
                textarea.addEventListener('keydown', handleTextareaKeyDown);
                textarea.addEventListener('paste', handleTextareaPaste);
                textarea.addEventListener('input', (event) => { // Combined input handler
                    clearDuplicateHighlights(); // Clear highlights when user types
                    handleTextareaInput(event); // Call original input logic
                });
                autoResizeTextarea(textarea);
            }
        });

        function extractSampleNumber(qrCode) {
            if (!qrCode || typeof qrCode !== 'string') return null;
            const parts = qrCode.trim().split(/\s+/);
            const lastPart = parts[parts.length - 1];
            const num = parseInt(lastPart, 10);
            return isNaN(num) ? null : num;
        }
        
        function checkForDuplicates() {
            const allScannedEntriesByCategory = {};
            const allEntriesFlat = [];
            let hasAnyInput = false;

            for (const categoryName in CATEGORY_CONFIG) {
                const textarea = CATEGORY_CONFIG[categoryName].textarea;
                if (textarea) {
                    const scansString = textarea.value.trim();
                    const scansArray = scansString ? scansString.split(/[\n,]+/).map(s => s.trim()).filter(s => s) : [];
                    if (scansArray.length > 0) hasAnyInput = true;
                    allScannedEntriesByCategory[categoryName] = scansArray;
                    allEntriesFlat.push(...scansArray);
                }
            }
            
            // if (!hasAnyInput && allEntriesFlat.length === 0) { // If no input at all, no duplicates
            //     return {};
            // }

            const entryCounts = {};
            allEntriesFlat.forEach(entry => {
                entryCounts[entry] = (entryCounts[entry] || 0) + 1;
            });

            const duplicateInfo = {}; 
            for (const entry in entryCounts) {
                if (entryCounts[entry] > 1) {
                    duplicateInfo[entry] = [];
                    for (const categoryName in allScannedEntriesByCategory) {
                        if (allScannedEntriesByCategory[categoryName].includes(entry)) {
                            duplicateInfo[entry].push(categoryName);
                        }
                    }
                }
            }
            return duplicateInfo;
        }


        sortSamplesBtn.addEventListener('click', () => {
            clearDuplicateHighlights(); 

            const duplicatesInfo = checkForDuplicates(); 
            const duplicateIdsFromCheck = Object.keys(duplicatesInfo);

            if (duplicateIdsFromCheck.length > 0) {
                showDuplicateAlertModal(duplicatesInfo); 
                showMessage('Duplicate sample IDs found. Please correct the entries.', 'error', 5000);
                return; 
            }
            
            processedScans = {};
            sortedScansByCategory = {};
            let totalScans = 0;

            for (const category in CATEGORY_CONFIG) {
                const textarea = CATEGORY_CONFIG[category].textarea;
                if (!textarea) continue;
                const scansString = textarea.value.trim(); 
                const scansArray = scansString ? scansString.split(/[\n,]+/).map(s => s.trim()).filter(s => s) : [];
                
                processedScans[category] = scansArray;
                totalScans += scansArray.length;

                sortedScansByCategory[category] = [...scansArray].sort((a, b) => {
                    const numA = extractSampleNumber(a);
                    const numB = extractSampleNumber(b);
                    if (numA === null && numB === null) return 0; 
                    if (numA === null) return 1; 
                    if (numB === null) return -1; 
                    return numA - numB; 
                });
            }

            if (totalScans === 0) {
                showMessage('No scan data entered in any category.', 'warning');
                displayNoResults();
                return;
            }

            displayAllResults();
            showMessage('Samples sorted and displayed!', 'success');
            resultsCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
        
        function displayNoResults() {
            noResultsMessage.classList.remove('hidden');
            outputsContainer.classList.add('hidden');
            exportButtonContainer.classList.add('hidden');
            noResultsMessage.querySelector('p').textContent = 'Enter scan data and click "Sort Samples" to see results here.';
             scanTextareas.forEach(textarea => {
                if (textarea) autoResizeTextarea(textarea);
            });
        }

        function displayAllResults() {
            noResultsMessage.classList.add('hidden');
            outputsContainer.classList.remove('hidden');
            exportButtonContainer.classList.remove('hidden');
            
            renderStorageBoxTable();
            renderSortedListTable();
        }

        function renderStorageBoxTable() {
            storageBoxContainer.innerHTML = ''; 
            const fragment = document.createDocumentFragment();
            const table = document.createElement('table');
            table.className = 'storage-box-table w-full text-slate-700 dark:text-slate-300';

            const thead = table.createTHead();
            const header = thead.insertRow();
            header.insertCell().outerHTML = "<th class='row-header'></th>"; 
            for (let i = 1; i <= 9; i++) {
                const th = document.createElement('th');
                th.className = 'row-header';
                th.textContent = i;
                header.appendChild(th);
            }

            const tbody = table.createTBody();
            ALL_ROW_LABELS.forEach(rowLabel => {
                const tr = tbody.insertRow();
                const th = document.createElement('th');
                th.className = 'row-header';
                th.textContent = rowLabel;
                tr.appendChild(th);

                let currentCategoryForThisRow = null;
                let categoryConfigForThisRow = null;
                for (const cat in CATEGORY_CONFIG) {
                    if (CATEGORY_CONFIG[cat].rows.includes(rowLabel)) {
                        currentCategoryForThisRow = cat;
                        categoryConfigForThisRow = CATEGORY_CONFIG[cat];
                        break;
                    }
                }

                for (let col = 1; col <= 9; col++) {
                    const td = tr.insertCell();
                    if (currentCategoryForThisRow && categoryConfigForThisRow) {
                        const samplesForCategory = processedScans[currentCategoryForThisRow];
                        const rowIndexInCat = categoryConfigForThisRow.rows.indexOf(rowLabel);
                        const slotIndex = (rowIndexInCat * 9) + (col - 1);

                        if (samplesForCategory && slotIndex < samplesForCategory.length) {
                            const sampleText = samplesForCategory[slotIndex];
                            td.title = sampleText; 

                            const lastSpaceIndex = sampleText.lastIndexOf(' ');
                            if (lastSpaceIndex > 0 && lastSpaceIndex < sampleText.length - 1) { 
                                const firstPart = sampleText.substring(0, lastSpaceIndex);
                                const lastPart = sampleText.substring(lastSpaceIndex + 1);
                                td.innerHTML = `${firstPart}<br>${lastPart}`;
                            } else {
                                td.textContent = sampleText; 
                            }
                        } else {
                            td.textContent = '-'; 
                            td.classList.add('empty-slot');
                        }
                    } else {
                        td.textContent = 'ERR'; 
                        td.classList.add('empty-slot', 'bg-red-200', 'dark:bg-red-700', 'text-red-700', 'dark:text-red-200');
                    }
                }
            });
            fragment.appendChild(table);
            storageBoxContainer.appendChild(fragment);
        }

        function renderSortedListTable() {
            sortedListContainer.innerHTML = ''; 
            const fragment = document.createDocumentFragment();
            const table = document.createElement('table');
            table.className = 'sorted-list-table min-w-full divide-y divide-slate-200 dark:divide-slate-700';
            
            const thead = table.createTHead();
            thead.className = 'bg-slate-50 dark:bg-slate-700';
            const headerRow = thead.insertRow();
            const categoryNames = Object.keys(CATEGORY_CONFIG);

            categoryNames.forEach(categoryName => {
                const th = document.createElement('th');
                th.scope = 'col';
                th.className = 'px-4 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider';
                const samplesForCategory = sortedScansByCategory[categoryName] || [];
                const count = samplesForCategory.length;
                th.textContent = `${categoryName.toUpperCase()} (${count})`;
                headerRow.appendChild(th);
            });

            const tbody = table.createTBody();
            tbody.className = 'bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700';
            
            let maxItems = 0;
            categoryNames.forEach(categoryName => {
                maxItems = Math.max(maxItems, (sortedScansByCategory[categoryName] || []).length);
            });

            if (maxItems === 0) {
                const tr = tbody.insertRow();
                const td = tr.insertCell();
                td.colSpan = categoryNames.length;
                td.className = 'text-center py-4 text-slate-500 dark:text-slate-400';
                td.textContent = 'No samples to display in sorted list.';
            } else {
                for (let i = 0; i < maxItems; i++) {
                    const tr = tbody.insertRow();
                    categoryNames.forEach(categoryName => {
                        const td = tr.insertCell();
                        td.className = 'px-4 py-3 whitespace-nowrap text-sm text-slate-600 dark:text-slate-300';
                        const sample = (sortedScansByCategory[categoryName] || [])[i];
                        
                        if (sample) {
                            const sampleNumber = extractSampleNumber(sample);
                            const categoryRules = CATEGORY_CONFIG[categoryName];
                            let iconHtml = '';

                            if (categoryRules.validRange) { 
                                const [min, max] = categoryRules.validRange;
                                if (sampleNumber !== null && sampleNumber >= min && sampleNumber <= max) {
                                    iconHtml = ' <i class="fas fa-check-circle text-green-500 ml-1 text-xs" title="Valid for category"></i>';
                                } else {
                                    iconHtml = ' <i class="fas fa-times-circle text-red-500 ml-1 text-xs" title="Invalid for category"></i>';
                                }
                            }
                            td.innerHTML = `<span>${sample}${iconHtml}</span>`;
                        } else {
                            td.textContent = ''; 
                        }
                    });
                }
            }
            fragment.appendChild(table);
            sortedListContainer.appendChild(fragment);
        }

        exportCsvBtn.addEventListener('click', () => {
            const csvRows = ["Category,Sorted Sample ID"];
            let hasDataToExport = false;

            Object.keys(CATEGORY_CONFIG).forEach(categoryName => {
                const sortedSamples = sortedScansByCategory[categoryName] || [];
                if (sortedSamples.length > 0) {
                    hasDataToExport = true;
                    sortedSamples.forEach(sampleId => {
                        const escapedSampleId = `"${String(sampleId).replace(/"/g, '""')}"`;
                        csvRows.push(`${categoryName},${escapedSampleId}`);
                    });
                }
            });

            if (!hasDataToExport) {
                showMessage('No sorted sample data to export.', 'warning');
                return;
            }

            const csvContent = csvRows.join("\n");
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            const date = new Date();
            const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            link.setAttribute("download", `sample_organizer_sorted_list_${dateStr}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showMessage('Sorted list exported to CSV.', 'success');
        });

        async function handlePdfGeneration() {
            const reportTitle = pdfReportNameInput.value.trim();
            if (!reportTitle) {
                pdfNameError.textContent = 'Report title cannot be empty.';
                pdfNameError.classList.remove('hidden');
                pdfReportNameInput.focus();
                return;
            }
            pdfNameError.classList.add('hidden');
            hidePdfNameModal();
            showMessage('Generating PDF, please wait...', 'info', 7000);

            const isDarkMode = document.documentElement.classList.contains('dark');
            if (isDarkMode) {
                document.documentElement.classList.remove('dark');
                await new Promise(resolve => setTimeout(resolve, 50));
            }

            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'p',
                    unit: 'pt',
                    format: 'a4'
                });

                const pageMargin = 40;
                const pageWidth = pdf.internal.pageSize.getWidth() - 2 * pageMargin;
                let currentY = pageMargin;

                pdf.setFontSize(18);
                pdf.setFont('helvetica', 'bold');
                pdf.text(reportTitle, pdf.internal.pageSize.getWidth() / 2, currentY, { align: 'center' });
                currentY += 30;

                pdf.setFontSize(14);
                pdf.setFont('helvetica', 'bold');
                pdf.text("Storage Box Layout (9x9)", pageMargin, currentY);
                currentY += 20;

                if (storageBoxContainer && storageBoxContainer.querySelector('table')) {
                    const canvasStorageBox = await html2canvas(storageBoxContainer.querySelector('table'), { 
                        scale: 2,
                        useCORS: true,
                        backgroundColor: '#ffffff' 
                    });
                    const imgDataStorageBox = canvasStorageBox.toDataURL('image/png');
                    const imgPropsStorageBox = pdf.getImageProperties(imgDataStorageBox);
                    const imgWidthStorageBox = pageWidth;
                    const imgHeightStorageBox = (imgPropsStorageBox.height * imgWidthStorageBox) / imgPropsStorageBox.width;

                    if (currentY + imgHeightStorageBox > pdf.internal.pageSize.getHeight() - pageMargin) {
                        pdf.addPage();
                        currentY = pageMargin;
                    }
                    pdf.addImage(imgDataStorageBox, 'PNG', pageMargin, currentY, imgWidthStorageBox, imgHeightStorageBox);
                    currentY += imgHeightStorageBox + 20;
                } else {
                    pdf.setFontSize(10);
                    pdf.setFont('helvetica', 'normal');
                    pdf.text("No storage box data available.", pageMargin, currentY);
                    currentY += 20;
                }

                if (currentY + 40 > pdf.internal.pageSize.getHeight() - pageMargin) {
                    pdf.addPage();
                    currentY = pageMargin;
                }
                pdf.setFontSize(14);
                pdf.setFont('helvetica', 'bold');
                pdf.text("Numerically Sorted Samples", pageMargin, currentY);
                currentY += 20;
                
                if (sortedListContainer && sortedListContainer.querySelector('table')) {
                     const canvasSortedList = await html2canvas(sortedListContainer.querySelector('table'), { 
                        scale: 2,
                        useCORS: true,
                        backgroundColor: '#ffffff'
                    });
                    const imgDataSortedList = canvasSortedList.toDataURL('image/png');
                    const imgPropsSortedList = pdf.getImageProperties(imgDataSortedList);
                    const imgWidthSortedList = pageWidth;
                    const imgHeightSortedList = (imgPropsSortedList.height * imgWidthSortedList) / imgPropsSortedList.width;

                    if (currentY + imgHeightSortedList > pdf.internal.pageSize.getHeight() - pageMargin) {
                        pdf.addPage();
                        currentY = pageMargin;
                    }
                    pdf.addImage(imgDataSortedList, 'PNG', pageMargin, currentY, imgWidthSortedList, imgHeightSortedList);
                } else {
                    pdf.setFontSize(10);
                    pdf.setFont('helvetica', 'normal');
                    pdf.text("No numerically sorted data available.", pageMargin, currentY);
                }

                const safeFileName = reportTitle.replace(/[^a-z0-9_-\s]/gi, '_').replace(/\s+/g, '_');
                pdf.save(`${safeFileName}.pdf`);
                showMessage('PDF report generated successfully!', 'success');

            } catch (error) {
                console.error("Error generating PDF:", error);
                showMessage(`Error generating PDF: ${error.message || 'Unknown error'}. Check console.`, 'error', 7000);
            } finally {
                if (isDarkMode) {
                    document.documentElement.classList.add('dark');
                }
            }
        }


        resetAppBtn.addEventListener('click', () => {
            showConfirmation('Reset Application', 'Are you sure you want to clear all scanned data and sorted outputs?', () => {
                clearDuplicateHighlights();
                scanTextareas.forEach(textarea => {
                    if(textarea) {
                        textarea.value = '';
                        autoResizeTextarea(textarea); 
                    }
                });
                processedScans = {};
                sortedScansByCategory = {};
                storageBoxContainer.innerHTML = '';
                sortedListContainer.innerHTML = '';
                displayNoResults();
                showMessage('Application has been reset.', 'info');
                hideConfirmation();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        });

        if (modalConfirmBtn) modalConfirmBtn.addEventListener('click', () => { if (confirmCallback) confirmCallback(); });
        if (modalCancelBtn) modalCancelBtn.addEventListener('click', hideConfirmation);
        
        if (duplicateAlertCloseBtn) {
            duplicateAlertCloseBtn.addEventListener('click', () => {
                hideDuplicateAlertModal();
                highlightDuplicateTextareas(currentDuplicateIds); // Highlight based on stored IDs
            });
        }


        function initializeApp() {
            applyThemeAndHeaderStyle();
            displayNoResults(); 
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();

            if (exportPdfBtn) {
                exportPdfBtn.addEventListener('click', () => {
                    if (outputsContainer.classList.contains('hidden')) {
                        showMessage('Please sort samples first to generate data for the PDF report.', 'warning');
                        return;
                    }
                    showPdfNameModal();
                });
            }
            if (pdfNameConfirmBtn) {
                pdfNameConfirmBtn.addEventListener('click', handlePdfGeneration);
            }
            if (pdfNameCancelBtn) {
                pdfNameCancelBtn.addEventListener('click', hidePdfNameModal);
            }
        });
    </script>
</body>
</html>
